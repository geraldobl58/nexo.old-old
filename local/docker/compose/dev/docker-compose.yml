# ============================================================================
# NEXO PLATFORM - Docker Compose (Development)
# ============================================================================
# Ambiente de desenvolvimento local com stack completa de observabilidade
#
# Usage:
#   docker compose -f infra/docker/compose/dev/docker-compose.yml up -d
#   docker compose -f infra/docker/compose/dev/docker-compose.yml logs -f
#   docker compose -f infra/docker/compose/dev/docker-compose.yml down -v
# ============================================================================

name: nexo-dev

services:
  # ==========================================
  # API - NestJS Backend (Container - Optional)
  # ==========================================
  # Para desenvolvimento local, rode: pnpm --filter nexo-be dev
  # Use este container apenas para testar build de produção
  nexo-be:
    profiles: ["full"]
    build:
      context: ../../../../
      dockerfile: ./apps/nexo-be/Dockerfile
      target: production
    container_name: nexo-be-dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - APP_NAME=Nexo
      - APP_URL=http://localhost:3000
      - FRONTEND_URL=http://localhost:3003
      - DATABASE_URL=postgresql://nexo:nexo_dev_password@postgres:5432/nexo_dev
      - DATABASE_POOL_MIN=2
      - DATABASE_POOL_MAX=10
      - REDIS_URL=redis://redis:6379
      - REDIS_TTL=3600
      - KEYCLOAK_URL=http://keycloak:8080
      - KEYCLOAK_REALM=nexo-dev
      - KEYCLOAK_CLIENT_ID=nexo-be
      - KEYCLOAK_ADMIN_USERNAME=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin_dev
      - JWT_SECRET=dev-secret-key-only-for-development
      - JWT_EXPIRATION=1d
      - JWT_REFRESH_EXPIRATION=7d
      - LOG_LEVEL=debug
      - LOG_FORMAT=json
      - SWAGGER_ENABLED=true
      - METRICS_ENABLED=true
    volumes:
      - ../../../../apps/nexo-be:/app/apps/nexo-be:delegated
      - ../../../../packages:/app/packages:delegated
      - /app/node_modules
      - api-uploads-dev:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - nexo-dev-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=3000"
      - "prometheus.path=/metrics"

  # ==========================================
  # Web - Next.js Frontend (Container - Optional)
  # ==========================================
  # Para desenvolvimento local, rode: pnpm --filter nexo-fe dev
  # Use este container apenas para testar build de produção
  nexo-fe:
    profiles: ["full"]
    build:
      context: ../../../../
      dockerfile: ./apps/nexo-fe/Dockerfile
      target: runner
    container_name: nexo-fe-dev
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:3000
      - NEXT_PUBLIC_KEYCLOAK_URL=http://localhost:8080
      - NEXT_PUBLIC_KEYCLOAK_REALM=nexo-dev
      - NEXT_PUBLIC_KEYCLOAK_CLIENT_ID=nexo-fe
    volumes:
      - ../../../../apps/nexo-fe:/app/apps/nexo-fe:delegated
      - ../../../../packages:/app/packages:delegated
      - /app/node_modules
      - /app/.next
    depends_on:
      nexo-be:
        condition: service_healthy
    networks:
      - nexo-dev-network
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3003', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================
  # Keycloak - Identity and Access Management
  # ==========================================
  keycloak:
    image: quay.io/keycloak/keycloak:26.0.7
    container_name: nexo-auth-dev
    command: start-dev
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "9000:9000"
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin_dev
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_HTTP_RELATIVE_PATH: /
      KC_SPI_THEME_STATIC_MAX_AGE: "-1"
      KC_SPI_THEME_CACHE_THEMES: "false"
      KC_SPI_THEME_CACHE_TEMPLATES: "false"
      KC_SPI_THEME_FOLDER_DIR: /opt/keycloak/themes
      KC_LOG_LEVEL: INFO
      # Using H2 database for development (default)
    volumes:
      - keycloak-data-dev:/opt/keycloak/data
      - ../../../../apps/nexo-auth/themes/nexo:/opt/keycloak/themes/nexo:ro
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/9000"]
      interval: 5s
      timeout: 2s
      retries: 30
      start_period: 15s
    labels:
      - "prometheus.scrape=true"
      - "prometheus.port=8080"
      - "prometheus.path=/metrics"

  # ==========================================
  # PostgreSQL Database
  # ==========================================
  postgres:
    image: postgres:16-alpine
    container_name: nexo-postgres-dev
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: nexo
      POSTGRES_PASSWORD: nexo_dev_password
      POSTGRES_DB: nexo_dev
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data-dev:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nexo -d nexo_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "log_statement=all"

  # ==========================================
  # Redis Cache
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: nexo-redis-dev
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data-dev:/data
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru

  # ==========================================
  # Prometheus - Metrics Collection
  # ==========================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: nexo-prometheus-dev
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prometheus-data-dev:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=7d"
      - "--web.enable-lifecycle"
      - "--web.enable-admin-api"
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Grafana - Dashboards & Visualization
  # ==========================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: nexo-grafana-dev
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin_dev
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: http://localhost:3001
      GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-piechart-panel
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data-dev:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Redis Exporter - Metrics for Redis
  # ==========================================
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: nexo-redis-exporter-dev
    restart: unless-stopped
    ports:
      - "9121:9121"
    environment:
      REDIS_ADDR: redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - nexo-dev-network

  # ==========================================
  # Postgres Exporter - Metrics for PostgreSQL
  # ==========================================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: nexo-postgres-exporter-dev
    restart: unless-stopped
    ports:
      - "9187:9187"
    environment:
      DATA_SOURCE_NAME: "postgresql://nexo:nexo_dev_password@postgres:5432/nexo_dev?sslmode=disable"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nexo-dev-network

  # ==========================================
  # Loki - Log Aggregation
  # ==========================================
  loki:
    image: grafana/loki:2.9.2
    container_name: nexo-loki-dev
    restart: unless-stopped
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki.yml:/etc/loki/loki.yml:ro
      - loki-data-dev:/loki
    command: -config.file=/etc/loki/loki.yml
    networks:
      - nexo-dev-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Promtail - Log Collection
  # ==========================================
  promtail:
    image: grafana/promtail:2.9.2
    container_name: nexo-promtail-dev
    restart: unless-stopped
    volumes:
      - ./promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/promtail.yml
    depends_on:
      - loki
    networks:
      - nexo-dev-network

  # ==========================================
  # NOTA: ArgoCD requer Kubernetes
  # ==========================================
  # ArgoCD não pode rodar standalone em Docker.
  # Para usar ArgoCD localmente, execute:
  #   make k8s-setup    (cria cluster K3d + ArgoCD)
  #   make argocd-open  (abre UI do ArgoCD)
  # ==========================================

# ==========================================
# Networks
# ==========================================
networks:
  nexo-dev-network:
    driver: bridge
    name: nexo-dev-network

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres-data-dev:
    name: nexo-postgres-data-dev
  redis-data-dev:
    name: nexo-redis-data-dev
  keycloak-data-dev:
    name: nexo-keycloak-data-dev
  api-uploads-dev:
    name: nexo-api-uploads-dev
  prometheus-data-dev:
    name: nexo-prometheus-data-dev
  grafana-data-dev:
    name: nexo-grafana-data-dev
  loki-data-dev:
    name: nexo-loki-data-dev
