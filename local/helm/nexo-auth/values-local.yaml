# =============================================================================
# Values for Local K3D environment
# =============================================================================
# Usa imagem do DockerHub - atualizada automaticamente pelo ArgoCD Image Updater
# Pipeline: push develop → CI builda → DockerHub → ArgoCD detecta → K3D atualiza
# =============================================================================

replicaCount: 1

image:
  repository: docker.io/geraldobl58/nexo-auth
  tag: "develop"
  pullPolicy: Always

imagePullSecrets:
  - name: dockerhub-creds

ingress:
  enabled: true
  className: "traefik"
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
    traefik.ingress.kubernetes.io/router.tls: "false"
    cert-manager.io/cluster-issuer: ""
  hosts:
    - host: develop.auth.nexo.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

resources:
  limits:
    cpu: 2000m
    memory: 2Gi
  requests:
    cpu: 500m
    memory: 1Gi

autoscaling:
  enabled: false

env:
  # Keycloak 26+ usa KC_BOOTSTRAP_ADMIN_*
  KC_BOOTSTRAP_ADMIN_USERNAME: admin
  KC_BOOTSTRAP_ADMIN_PASSWORD: admin
  KC_HOSTNAME_STRICT: "false"
  KC_PROXY: "edge"
  KC_HTTP_ENABLED: "true"
  KC_HEALTH_ENABLED: "true"
  KC_METRICS_ENABLED: "true"

# Command para iniciar em modo dev (local)
command:
  - /opt/keycloak/bin/kc.sh
args:
  - start-dev
  - --http-enabled=true
  - --hostname-strict=false
  - --http-port=8080

# Porta de gerenciamento (health, metrics) - Keycloak 26+ usa porta 9000
managementPort: 9000

# Probes ajustados para Keycloak 26+ (usa porta de gerenciamento)
livenessProbe:
  httpGet:
    path: /health/live
    port: management
  initialDelaySeconds: 120
  periodSeconds: 15
  timeoutSeconds: 10
  failureThreshold: 10

readinessProbe:
  httpGet:
    path: /health/ready
    port: management
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 10

podDisruptionBudget:
  enabled: false

# =============================================================================
# PostgreSQL - Habilitado para persistência de dados do Keycloak
# =============================================================================
postgresql:
  enabled: true
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent
  database: keycloak
  username: keycloak
  password: keycloak123
  persistence:
    enabled: true
    size: 2Gi
    accessMode: ReadWriteOnce
    storageClass: "local-path"
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
