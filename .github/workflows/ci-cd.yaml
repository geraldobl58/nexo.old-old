# ============================================================================
# Nexo Platform - CI/CD Pipeline
# ============================================================================
# Workflow completo estilo enterprise:
# 1. Build e testes no PR
# 2. Build de imagem e push no merge
# 3. Deploy automático por branch/ambiente
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches:
      - develop # Ambiente de desenvolvimento
      - qa # Ambiente de QA/testes
      - staging # Ambiente de staging/homologação
      - main # Ambiente de produção
    paths:
      - "apps/**"
      - "packages/**"
      - ".github/workflows/**"
  pull_request:
    branches:
      - develop
      - qa
      - staging
      - main
    paths:
      - "apps/**"
      - "packages/**"

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: geraldobl58

jobs:
  # ============================================================================
  # Job 1: Detectar mudanças e preparar matriz
  # ============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.filter.outputs.changes }}
      branch: ${{ steps.branch.outputs.name }}
      tag: ${{ steps.tag.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed apps
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            nexo-be:
              - 'apps/nexo-be/**'
              - 'packages/**'
            nexo-fe:
              - 'apps/nexo-fe/**'
              - 'packages/**'
            nexo-auth:
              - 'apps/nexo-auth/**'

      - name: Get branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi

      - name: Define tag strategy
        id: tag
        run: |
          BRANCH="${{ steps.branch.outputs.name }}"

          # Mapeamento de branches para tags/ambientes
          case "$BRANCH" in
            develop)
              echo "name=develop" >> $GITHUB_OUTPUT
              ;;
            qa)
              echo "name=qa" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "name=staging" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "name=latest" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              ;;
          esac

  # ============================================================================
  # Job 2: Build e Testes (executa em PRs e pushes)
  # ============================================================================
  test:
    name: Test - ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.apps != '[]'
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        run: pnpm --filter ${{ matrix.app }} lint
        continue-on-error: true

      - name: Run tests
        run: pnpm --filter ${{ matrix.app }} test
        continue-on-error: true

      - name: Build application
        run: pnpm --filter ${{ matrix.app }} build

  # ============================================================================
  # Job 3: Build e Push de Imagens Docker (apenas em push, não em PRs)
  # ============================================================================
  build-and-push:
    name: Build & Push - ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: |
      github.event_name == 'push' && 
      needs.detect-changes.outputs.apps != '[]' &&
      (github.ref == 'refs/heads/develop' || 
       github.ref == 'refs/heads/qa' || 
       github.ref == 'refs/heads/staging' || 
       github.ref == 'refs/heads/main')
    strategy:
      matrix:
        app: ${{ fromJSON(needs.detect-changes.outputs.apps) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ matrix.app }}
          tags: |
            type=raw,value=${{ needs.detect-changes.outputs.tag }}
            type=sha,prefix=${{ needs.detect-changes.outputs.tag }}-,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/${{ matrix.app }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ matrix.app }}:${{ needs.detect-changes.outputs.tag }}
          cache-to: type=inline
          build-args: |
            APP_NAME=${{ matrix.app }}

      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.meta.outputs.digest }}"

  # ============================================================================
  # Job 4: Notificação de sucesso
  # ============================================================================
  notify-success:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-push]
    if: success()
    steps:
      - name: Deployment summary
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ needs.detect-changes.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.detect-changes.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Apps:** ${{ needs.detect-changes.outputs.apps }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD Image Updater detectará as novas imagens e fará o deploy automaticamente." >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 5: Notificação de falha
  # ============================================================================
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [detect-changes, test, build-and-push]
    if: failure()
    steps:
      - name: Failure summary
        run: |
          echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
