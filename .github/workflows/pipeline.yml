# ============================================================================
# Nexo Platform - Unified CI/CD Pipeline
# ============================================================================
# Pipeline unificada que:
# - Detecta mudanÃ§as por serviÃ§o (nexo-be, nexo-fe, nexo-auth)
# - Executa CI apenas para serviÃ§os alterados
# - Faz build e push de imagens para GitHub Container Registry (GHCR)
# - Deploy APENAS no ambiente correspondente Ã  branch
# - Atualiza image tag nos values files para ArgoCD sincronizar
#
# Branch â†’ Environment:
#   develop â†’ nexo-develop
#   qa â†’ nexo-qa
#   staging â†’ nexo-staging
#   main â†’ nexo-prod
#
# Registry: ghcr.io (sem rate limits como DockerHub)
# ============================================================================

name: Pipeline

on:
  push:
    branches:
      - develop
      - qa
      - staging
      - main
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/pipeline.yml"

  pull_request:
    branches:
      - develop
      - qa
      - staging
      - main
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/pipeline.yml"

  workflow_dispatch:
    inputs:
      force_all:
        description: "ForÃ§ar build de todos os serviÃ§os"
        type: boolean
        default: false

env:
  # GitHub Container Registry (GHCR) - sem rate limits
  REGISTRY: ghcr.io
  # RepositÃ³rio owner (usuÃ¡rio ou organizaÃ§Ã£o)
  IMAGE_OWNER: ${{ github.repository_owner }}

# Evita execuÃ§Ãµes concorrentes na mesma branch
concurrency:
  group: pipeline-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

jobs:
  # ==========================================================================
  # STAGE 1: Pre-flight Checks
  # ==========================================================================
  preflight:
    name: ðŸ” Pre-flight
    runs-on: ubuntu-latest
    # Pula se for commit do bot ou contiver [skip ci]
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      github.actor != 'github-actions[bot]'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      branch: ${{ steps.info.outputs.branch }}
      environment: ${{ steps.info.outputs.environment }}
      namespace: ${{ steps.info.outputs.namespace }}
      is_pr: ${{ steps.info.outputs.is_pr }}
      build_number: ${{ steps.build_number.outputs.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Skip
        id: check
        run: |
          echo "âœ… Pipeline will run"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Extract Info
        id: info
        run: |
          # Determinar branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH="${{ github.base_ref }}"
            IS_PR="true"
          else
            BRANCH="${{ github.ref_name }}"
            IS_PR="false"
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT

          # Mapear branch â†’ environment â†’ namespace
          case "$BRANCH" in
            develop)
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "namespace=nexo-develop" >> $GITHUB_OUTPUT
              ;;
            qa)
              echo "environment=qa" >> $GITHUB_OUTPUT
              echo "namespace=nexo-qa" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "namespace=nexo-staging" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "namespace=nexo-prod" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=unknown" >> $GITHUB_OUTPUT
              echo "namespace=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "ðŸ“‹ Branch: $BRANCH"
          echo "ðŸŽ¯ Environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "ðŸ“¦ Namespace: $(cat $GITHUB_OUTPUT | grep namespace | cut -d= -f2)"

      - name: Generate Build Number
        id: build_number
        run: |
          # Contar commits na branch atual para gerar nÃºmero de build
          BUILD_NUM=$(git rev-list --count HEAD)
          # Formatar como #001, #002, etc
          FORMATTED=$(printf "#%03d" $BUILD_NUM)
          echo "number=$FORMATTED" >> $GITHUB_OUTPUT
          echo "ðŸ”¢ Build Number: $FORMATTED"

  # ==========================================================================
  # STAGE 2: Detect Changes
  # ==========================================================================
  detect-changes:
    name: ðŸ”Ž Detect Changes
    runs-on: ubuntu-latest
    needs: preflight
    outputs:
      nexo-be: ${{ steps.summary.outputs.nexo-be }}
      nexo-fe: ${{ steps.summary.outputs.nexo-fe }}
      nexo-auth: ${{ steps.summary.outputs.nexo-auth }}
      any-change: ${{ steps.summary.outputs.any-change }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            nexo-be:
              - 'apps/nexo-be/**'
              - 'packages/**'
            nexo-fe:
              - 'apps/nexo-fe/**'
              - 'packages/**'
            nexo-auth:
              - 'apps/nexo-auth/**'

      - name: Check for merge commits
        id: merge-check
        run: |
          BRANCH="${{ needs.preflight.outputs.branch }}"

          # Verificar se Ã© um merge commit (tem mais de 1 parent)
          if git rev-parse --verify HEAD^2 >/dev/null 2>&1; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "ðŸ”€ Merge commit detected"
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ Regular commit"
          fi

          # Para qa, staging e main, sempre buildar tudo em caso de merge
          if [[ "$BRANCH" =~ ^(qa|staging|main)$ ]]; then
            echo "force_build=true" >> $GITHUB_OUTPUT
            echo "ðŸš€ Force build enabled for $BRANCH"
          else
            echo "force_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        id: summary
        run: |
          BE="${{ steps.filter.outputs.nexo-be }}"
          FE="${{ steps.filter.outputs.nexo-fe }}"
          AUTH="${{ steps.filter.outputs.nexo-auth }}"
          FORCE="${{ inputs.force_all }}"
          FORCE_BUILD="${{ steps.merge-check.outputs.force_build }}"
          IS_MERGE="${{ steps.merge-check.outputs.is_merge }}"
          BRANCH="${{ needs.preflight.outputs.branch }}"

          echo "ðŸ“Š Detection Results:"
          echo "  - Branch: $BRANCH"
          echo "  - Is Merge: $IS_MERGE"
          echo "  - Force Build: $FORCE_BUILD"
          echo "  - Filter BE: $BE"
          echo "  - Filter FE: $FE"
          echo "  - Filter AUTH: $AUTH"

          # LÃ³gica de decisÃ£o:
          # 1. Se force_all=true (manual), buildar tudo
          # 2. Se Ã© qa/staging/main, buildar tudo (promoÃ§Ã£o)
          # 3. SenÃ£o, usar detecÃ§Ã£o de paths

          if [[ "$FORCE" == "true" || "$FORCE_BUILD" == "true" ]]; then
            echo "ðŸš€ Building all services (force mode)"
            echo "nexo-be=true" >> $GITHUB_OUTPUT
            echo "nexo-fe=true" >> $GITHUB_OUTPUT
            echo "nexo-auth=true" >> $GITHUB_OUTPUT
            echo "any-change=true" >> $GITHUB_OUTPUT
          else
            echo "nexo-be=$BE" >> $GITHUB_OUTPUT
            echo "nexo-fe=$FE" >> $GITHUB_OUTPUT
            echo "nexo-auth=$AUTH" >> $GITHUB_OUTPUT
            
            if [[ "$BE" == "true" || "$FE" == "true" || "$AUTH" == "true" ]]; then
              echo "any-change=true" >> $GITHUB_OUTPUT
            else
              echo "any-change=false" >> $GITHUB_OUTPUT
            fi
          fi

          echo "### ðŸ“¦ Services Changed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-be | $(grep 'nexo-be=' $GITHUB_OUTPUT | cut -d= -f2) |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-fe | $(grep 'nexo-fe=' $GITHUB_OUTPUT | cut -d= -f2) |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-auth | $(grep 'nexo-auth=' $GITHUB_OUTPUT | cut -d= -f2) |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # STAGE 3: CI - Backend
  # ==========================================================================
  ci-backend:
    name: ðŸ”µ CI Backend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-be == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter nexo-be lint
        continue-on-error: true

      - name: Test
        run: pnpm --filter nexo-be test
        continue-on-error: true

      - name: Build
        run: pnpm --filter nexo-be build

  # ==========================================================================
  # STAGE 4: CI - Frontend
  # ==========================================================================
  ci-frontend:
    name: ðŸŸ¢ CI Frontend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-fe == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter nexo-fe lint
        continue-on-error: true

      - name: Build
        run: pnpm --filter nexo-fe build

  # ==========================================================================
  # STAGE 5: CI - Auth (apenas Docker build)
  # ==========================================================================
  ci-auth:
    name: ðŸŸ¡ CI Auth
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-auth == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        run: |
          if [ -f apps/nexo-auth/Dockerfile ]; then
            echo "âœ… Dockerfile exists"
          else
            echo "âŒ Dockerfile not found"
            exit 1
          fi

  # ==========================================================================
  # STAGE 6: Build & Push - Backend
  # ==========================================================================
  build-backend:
    name: ðŸ³ Build Backend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-backend]
    if: |
      github.event_name == 'push' &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-be == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-be/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "âœ… Backend image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 7: Build & Push - Frontend
  # ==========================================================================
  build-frontend:
    name: ðŸ³ Build Frontend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-frontend]
    if: |
      github.event_name == 'push' &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-fe == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-fe/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "âœ… Frontend image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 8: Build & Push - Auth
  # ==========================================================================
  build-auth:
    name: ðŸ³ Build Auth
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-auth]
    if: |
      github.event_name == 'push' &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-auth == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-auth/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "âœ… Auth image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 9: Deploy (Update K8s values)
  # ==========================================================================
  deploy:
    name: ðŸš€ Deploy ${{ needs.preflight.outputs.environment }}
    runs-on: ubuntu-latest
    needs:
      - preflight
      - detect-changes
      - build-backend
      - build-frontend
      - build-auth
    if: |
      always() &&
      github.event_name == 'push' &&
      needs.preflight.outputs.is_pr == 'false' &&
      needs.preflight.outputs.environment != 'unknown' &&
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-auth.result == 'success' || needs.build-auth.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update all values files
        run: |
          ENV="${{ needs.preflight.outputs.environment }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BRANCH="${{ needs.preflight.outputs.branch }}"
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_OWNER="${{ env.IMAGE_OWNER }}"

          echo "ðŸ”„ Updating values for environment: $ENV"
          echo "ðŸ“ Commit SHA: $SHORT_SHA"
          echo "ðŸ·ï¸ Image Tag: $BRANCH-$COMMIT_SHA"
          echo "ðŸ“¦ Registry: $REGISTRY/$IMAGE_OWNER"

          # Atualizar todos os serviÃ§os que tiveram build ou foram forÃ§ados
          for SERVICE in nexo-be nexo-fe nexo-auth; do
            VALUES_FILE="local/helm/${SERVICE}/values-${ENV}.yaml"
            
            if [ -f "$VALUES_FILE" ]; then
              # Atualizar tag da imagem para SHA especÃ­fico
              sed -i "s|tag: \"[^\"]*\"|tag: \"${BRANCH}-${COMMIT_SHA}\"|" "$VALUES_FILE"
              
              # Atualizar annotation de commit (se existir)
              sed -i "s/app.kubernetes.io\/commit: \"[^\"]*\"/app.kubernetes.io\/commit: \"$SHORT_SHA\"/" "$VALUES_FILE"
              
              # Garantir que repository estÃ¡ correto (GHCR)
              sed -i "s|repository: .*/${SERVICE}|repository: ${REGISTRY}/${IMAGE_OWNER}/${SERVICE}|" "$VALUES_FILE"
              
              git add "$VALUES_FILE"
              echo "âœ… Updated $VALUES_FILE"
              echo "   - tag: ${BRANCH}-${COMMIT_SHA}"
              echo "   - repository: ${REGISTRY}/${IMAGE_OWNER}/${SERVICE}"
            else
              echo "âš ï¸ Values file not found: $VALUES_FILE"
            fi
          done

      - name: Commit and push
        run: |
          ENV="${{ needs.preflight.outputs.environment }}"
          NAMESPACE="${{ needs.preflight.outputs.namespace }}"
          BUILD_NUM="${{ needs.preflight.outputs.build_number }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"

          # Verificar se hÃ¡ mudanÃ§as
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit"
            exit 0
          fi

          # Listar serviÃ§os que foram deployados baseado em quais builds rodaram
          SERVICES=""
          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-be"
          fi
          if [ "${{ needs.build-frontend.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-fe"
          fi
          if [ "${{ needs.build-auth.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-auth"
          fi

          # Se nenhum build rodou (todos skipped), significa que forÃ§amos build de tudo
          if [ -z "$SERVICES" ]; then
            SERVICES=" nexo-be nexo-fe nexo-auth"
          fi

          # Formato: #001 : deploy(prod): nexo-be nexo-fe â†’ abc1234
          git commit -m "${BUILD_NUM} : deploy(${ENV}):${SERVICES} â†’ ${SHORT_SHA} [skip ci]"
          git push origin ${{ github.ref_name }}

          echo "âœ… Deployed to $NAMESPACE"

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.preflight.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: ${{ needs.preflight.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-be | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-fe | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-auth | ${{ needs.build-auth.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD detectarÃ¡ as mudanÃ§as e farÃ¡ sync automaticamente." >> $GITHUB_STEP_SUMMARY
