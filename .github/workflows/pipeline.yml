# ============================================================================
# Nexo Platform - Unified CI/CD Pipeline
# ============================================================================
# Pipeline unificada que:
# - Detecta mudan√ßas por servi√ßo (nexo-be, nexo-fe, nexo-auth)
# - Executa CI apenas para servi√ßos alterados
# - Faz build e push de imagens para GitHub Container Registry (GHCR)
# - Deploy APENAS no ambiente correspondente √† branch
# - Atualiza image tag nos values files para ArgoCD sincronizar
#
# Branch ‚Üí Environment:
#   develop ‚Üí nexo-develop
#   qa ‚Üí nexo-qa
#   staging ‚Üí nexo-staging
#   main ‚Üí nexo-prod
#
# Registry: ghcr.io (sem rate limits como DockerHub)
# ============================================================================

name: Pipeline

on:
  push:
    branches:
      - develop
      - qa
      - staging
      - main
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/pipeline.yml"

  pull_request:
    branches:
      - develop
      - qa
      - staging
      - main
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/pipeline.yml"

  workflow_dispatch:
    inputs:
      force_all:
        description: "For√ßar build de todos os servi√ßos"
        type: boolean
        default: false

env:
  # GitHub Container Registry (GHCR) - sem rate limits
  REGISTRY: ghcr.io
  # Reposit√≥rio owner (usu√°rio ou organiza√ß√£o)
  IMAGE_OWNER: ${{ github.repository_owner }}

# Evita execu√ß√µes concorrentes na mesma branch
# Apenas novos pushes cancelam execu√ß√µes anteriores (n√£o re-runs)
concurrency:
  group: pipeline-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  pull-requests: write # Necess√°rio para Danger.js comentar em PRs
  issues: write # Necess√°rio para Danger.js

jobs:
  # ==========================================================================
  # STAGE 0: AI Code Review (apenas PRs)
  # ==========================================================================
  ai-review:
    name: ü§ñ AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        working-directory: apps/nexo-fe
        run: npm install danger

      - name: Run Danger.js
        working-directory: apps/nexo-fe
        run: npx danger ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: CodeRabbit Summary
        run: |
          echo "## üê∞ CodeRabbit Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "CodeRabbit est√° revisando este PR automaticamente." >> $GITHUB_STEP_SUMMARY
          echo "Os coment√°rios aparecer√£o em breve na aba 'Files changed'." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verifica√ß√µes realizadas:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Clean Architecture (Backend nexo-be)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ TypeScript Best Practices" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ React/Next.js Patterns (Frontend nexo-fe)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Seguran√ßa e Performance" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Testes" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # STAGE 1: Pre-flight Checks
  # ==========================================================================
  preflight:
    name: üîç Pre-flight
    runs-on: ubuntu-latest
    # N√£o depende de ai-review porque ele s√≥ roda em PRs
    if: |
      !contains(github.event.head_commit.message, '[skip ci]') &&
      github.actor != 'github-actions[bot]'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      branch: ${{ steps.info.outputs.branch }}
      environment: ${{ steps.info.outputs.environment }}
      namespace: ${{ steps.info.outputs.namespace }}
      is_pr: ${{ steps.info.outputs.is_pr }}
      build_number: ${{ steps.build_number.outputs.number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Skip
        id: check
        run: |
          echo "‚úÖ Pipeline will run"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Extract Info
        id: info
        run: |
          # Determinar branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BRANCH="${{ github.base_ref }}"
            IS_PR="true"
          else
            BRANCH="${{ github.ref_name }}"
            IS_PR="false"
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT

          # Mapear branch ‚Üí environment ‚Üí namespace
          case "$BRANCH" in
            develop)
              echo "environment=dev" >> $GITHUB_OUTPUT
              echo "namespace=nexo-develop" >> $GITHUB_OUTPUT
              ;;
            qa)
              echo "environment=qa" >> $GITHUB_OUTPUT
              echo "namespace=nexo-qa" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "environment=staging" >> $GITHUB_OUTPUT
              echo "namespace=nexo-staging" >> $GITHUB_OUTPUT
              ;;
            main)
              echo "environment=prod" >> $GITHUB_OUTPUT
              echo "namespace=nexo-prod" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=unknown" >> $GITHUB_OUTPUT
              echo "namespace=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

          echo "üìã Branch: $BRANCH"
          echo "üéØ Environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "üì¶ Namespace: $(cat $GITHUB_OUTPUT | grep namespace | cut -d= -f2)"

      - name: Generate Build Number
        id: build_number
        run: |
          # Contar commits na branch atual para gerar n√∫mero de build
          BUILD_NUM=$(git rev-list --count HEAD)
          # Formatar como #001, #002, etc
          FORMATTED=$(printf "#%03d" $BUILD_NUM)
          echo "number=$FORMATTED" >> $GITHUB_OUTPUT
          echo "üî¢ Build Number: $FORMATTED"

  # ==========================================================================
  # STAGE 2: Detect Changes
  # ==========================================================================
  detect-changes:
    name: üîé Detect Changes
    runs-on: ubuntu-latest
    needs: preflight
    outputs:
      nexo-be: ${{ steps.summary.outputs.nexo-be }}
      nexo-fe: ${{ steps.summary.outputs.nexo-fe }}
      nexo-auth: ${{ steps.summary.outputs.nexo-auth }}
      any-change: ${{ steps.summary.outputs.any-change }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          # Usar compara√ß√£o com a branch base para detectar mudan√ßas corretas
          base: ${{ github.event.before || github.event.pull_request.base.sha }}
          filters: |
            nexo-be:
              - 'apps/nexo-be/**'
              - 'packages/**'
            nexo-fe:
              - 'apps/nexo-fe/**'
              - 'packages/**'
            nexo-auth:
              - 'apps/nexo-auth/**'

      - name: Detect changes from merge (fallback)
        id: merge-files
        run: |
          # Detectar arquivos alterados no √∫ltimo commit (incluindo merges)
          echo "üìÇ Checking changed files..."

          # Para merge commits, comparar com o primeiro parent
          if git rev-parse --verify HEAD^2 >/dev/null 2>&1; then
            # √â um merge commit - comparar HEAD^1 (branch destino) com HEAD
            CHANGED_FILES=$(git diff --name-only HEAD^1 HEAD)
          else
            # Commit normal - comparar com parent
            CHANGED_FILES=$(git diff --name-only HEAD^ HEAD 2>/dev/null || echo "")
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Verificar cada servi√ßo
          if echo "$CHANGED_FILES" | grep -q "^apps/nexo-be/"; then
            echo "nexo-be=true" >> $GITHUB_OUTPUT
            echo "‚úÖ nexo-be has changes"
          else
            echo "nexo-be=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^apps/nexo-fe/"; then
            echo "nexo-fe=true" >> $GITHUB_OUTPUT
            echo "‚úÖ nexo-fe has changes"
          else
            echo "nexo-fe=false" >> $GITHUB_OUTPUT
          fi

          if echo "$CHANGED_FILES" | grep -q "^apps/nexo-auth/"; then
            echo "nexo-auth=true" >> $GITHUB_OUTPUT
            echo "‚úÖ nexo-auth has changes"
          else
            echo "nexo-auth=false" >> $GITHUB_OUTPUT
          fi

          # Verificar packages (afeta todos os servi√ßos que usam packages)
          if echo "$CHANGED_FILES" | grep -q "^packages/"; then
            echo "packages=true" >> $GITHUB_OUTPUT
            echo "‚úÖ packages has changes (may affect be/fe)"
          else
            echo "packages=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for merge commits
        id: merge-check
        run: |
          BRANCH="${{ needs.preflight.outputs.branch }}"

          # Verificar se √© um merge commit (tem mais de 1 parent)
          if git rev-parse --verify HEAD^2 >/dev/null 2>&1; then
            echo "is_merge=true" >> $GITHUB_OUTPUT
            echo "üîÄ Merge commit detected"
          else
            echo "is_merge=false" >> $GITHUB_OUTPUT
            echo "üìù Regular commit"
          fi

          # N√£o for√ßar build de todos - usar detec√ß√£o de paths mesmo em qa/staging/main
          # Isso permite que apenas os servi√ßos modificados sejam buildados
          echo "force_build=false" >> $GITHUB_OUTPUT
          echo "üìä Using path detection for selective builds"

      - name: Summary
        id: summary
        run: |
          # Combinar resultados do paths-filter e merge-files detection
          FILTER_BE="${{ steps.filter.outputs.nexo-be }}"
          FILTER_FE="${{ steps.filter.outputs.nexo-fe }}"
          FILTER_AUTH="${{ steps.filter.outputs.nexo-auth }}"

          MERGE_BE="${{ steps.merge-files.outputs.nexo-be }}"
          MERGE_FE="${{ steps.merge-files.outputs.nexo-fe }}"
          MERGE_AUTH="${{ steps.merge-files.outputs.nexo-auth }}"
          PACKAGES="${{ steps.merge-files.outputs.packages }}"

          FORCE="${{ inputs.force_all }}"
          IS_MERGE="${{ steps.merge-check.outputs.is_merge }}"
          BRANCH="${{ needs.preflight.outputs.branch }}"

          echo "üìä Detection Results:"
          echo "  - Branch: $BRANCH"
          echo "  - Is Merge: $IS_MERGE"
          echo "  - Force All: $FORCE"
          echo ""
          echo "  paths-filter results:"
          echo "    - BE: $FILTER_BE"
          echo "    - FE: $FILTER_FE"
          echo "    - AUTH: $FILTER_AUTH"
          echo ""
          echo "  merge-files results:"
          echo "    - BE: $MERGE_BE"
          echo "    - FE: $MERGE_FE"
          echo "    - AUTH: $MERGE_AUTH"
          echo "    - Packages: $PACKAGES"

          # Decis√£o final: usar OR entre paths-filter e merge-files
          # Se qualquer um detectar mudan√ßa, considerar como true

          if [[ "$FORCE" == "true" ]]; then
            echo "üöÄ Building all services (force mode)"
            BE_FINAL="true"
            FE_FINAL="true"
            AUTH_FINAL="true"
          else
            # BE: detectado por filter OU merge-files OU packages mudou
            if [[ "$FILTER_BE" == "true" || "$MERGE_BE" == "true" || "$PACKAGES" == "true" ]]; then
              BE_FINAL="true"
            else
              BE_FINAL="false"
            fi
            
            # FE: detectado por filter OU merge-files OU packages mudou
            if [[ "$FILTER_FE" == "true" || "$MERGE_FE" == "true" || "$PACKAGES" == "true" ]]; then
              FE_FINAL="true"
            else
              FE_FINAL="false"
            fi
            
            # AUTH: detectado por filter OU merge-files (n√£o usa packages)
            if [[ "$FILTER_AUTH" == "true" || "$MERGE_AUTH" == "true" ]]; then
              AUTH_FINAL="true"
            else
              AUTH_FINAL="false"
            fi
          fi

          echo ""
          echo "üéØ Final decision:"
          echo "  - nexo-be: $BE_FINAL"
          echo "  - nexo-fe: $FE_FINAL"
          echo "  - nexo-auth: $AUTH_FINAL"

          echo "nexo-be=$BE_FINAL" >> $GITHUB_OUTPUT
          echo "nexo-fe=$FE_FINAL" >> $GITHUB_OUTPUT
          echo "nexo-auth=$AUTH_FINAL" >> $GITHUB_OUTPUT

          if [[ "$BE_FINAL" == "true" || "$FE_FINAL" == "true" || "$AUTH_FINAL" == "true" ]]; then
            echo "any-change=true" >> $GITHUB_OUTPUT
          else
            echo "any-change=false" >> $GITHUB_OUTPUT
          fi

          echo "### üì¶ Services Changed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-be | $BE_FINAL |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-fe | $FE_FINAL |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-auth | $AUTH_FINAL |" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # STAGE 3: CI - Backend
  # ==========================================================================
  ci-backend:
    name: üîµ CI Backend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-be == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter nexo-be lint
        continue-on-error: true

      - name: Test
        run: pnpm --filter nexo-be test
        continue-on-error: true

      - name: Build
        run: pnpm --filter nexo-be build

  # ==========================================================================
  # STAGE 4: CI - Frontend
  # ==========================================================================
  ci-frontend:
    name: üü¢ CI Frontend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-fe == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter nexo-fe lint
        continue-on-error: true

      - name: Build
        run: pnpm --filter nexo-fe build

  # ==========================================================================
  # STAGE 5: CI - Auth (apenas Docker build)
  # ==========================================================================
  ci-auth:
    name: üü° CI Auth
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes]
    if: |
      needs.detect-changes.outputs.nexo-auth == 'true' || 
      inputs.force_all == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Dockerfile
        run: |
          if [ -f apps/nexo-auth/Dockerfile ]; then
            echo "‚úÖ Dockerfile exists"
          else
            echo "‚ùå Dockerfile not found"
            exit 1
          fi

  # ==========================================================================
  # STAGE 6: Build & Push - Backend
  # ==========================================================================
  build-backend:
    name: üê≥ Build Backend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-backend]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-be == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-be/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "‚úÖ Backend image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-be:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 7: Build & Push - Frontend
  # ==========================================================================
  build-frontend:
    name: üê≥ Build Frontend
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-frontend]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-fe == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-fe/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "‚úÖ Frontend image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-fe:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 8: Build & Push - Auth
  # ==========================================================================
  build-auth:
    name: üê≥ Build Auth
    runs-on: ubuntu-latest
    needs: [preflight, detect-changes, ci-auth]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.preflight.outputs.is_pr == 'false' &&
      (needs.detect-changes.outputs.nexo-auth == 'true' || inputs.force_all == true)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/nexo-auth/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}-${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}
          cache-to: type=inline

      - name: Summary
        run: |
          echo "‚úÖ Auth image pushed: ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/nexo-auth:${{ needs.preflight.outputs.branch }}"

  # ==========================================================================
  # STAGE 9: Deploy (Update K8s values)
  # ==========================================================================
  deploy:
    name: üöÄ Deploy ${{ needs.preflight.outputs.environment }}
    runs-on: ubuntu-latest
    needs:
      - preflight
      - detect-changes
      - build-backend
      - build-frontend
      - build-auth
    if: |
      always() &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      needs.preflight.outputs.is_pr == 'false' &&
      needs.preflight.outputs.environment != 'unknown' &&
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-auth.result == 'success' || needs.build-auth.result == 'skipped')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update values files for changed services only
        run: |
          ENV="${{ needs.preflight.outputs.environment }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BRANCH="${{ needs.preflight.outputs.branch }}"
          REGISTRY="${{ env.REGISTRY }}"
          IMAGE_OWNER="${{ env.IMAGE_OWNER }}"

          echo "üîÑ Updating values for environment: $ENV"
          echo "üìù Commit SHA: $SHORT_SHA"
          echo "üè∑Ô∏è Image Tag: $BRANCH-$COMMIT_SHA"
          echo "üì¶ Registry: $REGISTRY/$IMAGE_OWNER"

          # Fun√ß√£o para atualizar um servi√ßo espec√≠fico
          update_service() {
            local SERVICE=$1
            local VALUES_FILE="local/helm/${SERVICE}/values-${ENV}.yaml"
            
            if [ -f "$VALUES_FILE" ]; then
              # Para nexo-auth, apenas atualizar a tag da imagem principal (n√£o do PostgreSQL)
              if [ "$SERVICE" == "nexo-auth" ]; then
                # Usar awk para atualizar apenas a tag da se√ß√£o image (antes de postgresql)
                awk -v new_tag="${BRANCH}-${COMMIT_SHA}" '
                  BEGIN { found=0 }
                  /^image:/ { in_image=1 }
                  /^postgresql:/ { in_image=0 }
                  in_image && /tag:/ && !found { 
                    sub(/tag: "[^"]*"/, "tag: \"" new_tag "\"")
                    found=1
                  }
                  { print }
                ' "$VALUES_FILE" > "$VALUES_FILE.tmp" && mv "$VALUES_FILE.tmp" "$VALUES_FILE"
              else
                # Para outros servi√ßos, atualizar tag normalmente
                sed -i "s|tag: \"[^\"]*\"|tag: \"${BRANCH}-${COMMIT_SHA}\"|" "$VALUES_FILE"
              fi
              
              # Atualizar annotation de commit (se existir)
              sed -i "s/app.kubernetes.io\/commit: \"[^\"]*\"/app.kubernetes.io\/commit: \"$SHORT_SHA\"/" "$VALUES_FILE"
              
              # Garantir que repository est√° correto (GHCR)
              sed -i "s|repository: .*/${SERVICE}|repository: ${REGISTRY}/${IMAGE_OWNER}/${SERVICE}|" "$VALUES_FILE"
              
              git add "$VALUES_FILE"
              echo "‚úÖ Updated $VALUES_FILE"
              echo "   - tag: ${BRANCH}-${COMMIT_SHA}"
            else
              echo "‚ö†Ô∏è Values file not found: $VALUES_FILE"
            fi
          }

          # Atualizar APENAS os servi√ßos que foram buildados com sucesso
          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            echo "üì¶ Updating nexo-be (build was successful)"
            update_service "nexo-be"
          else
            echo "‚è≠Ô∏è Skipping nexo-be (build was ${{ needs.build-backend.result }})"
          fi

          if [ "${{ needs.build-frontend.result }}" == "success" ]; then
            echo "üì¶ Updating nexo-fe (build was successful)"
            update_service "nexo-fe"
          else
            echo "‚è≠Ô∏è Skipping nexo-fe (build was ${{ needs.build-frontend.result }})"
          fi

          if [ "${{ needs.build-auth.result }}" == "success" ]; then
            echo "üì¶ Updating nexo-auth (build was successful)"
            update_service "nexo-auth"
          else
            echo "‚è≠Ô∏è Skipping nexo-auth (build was ${{ needs.build-auth.result }})"
          fi

          echo ""
          echo "üìã Summary of updates:"
          git diff --cached --name-only || echo "No changes"

      - name: Commit and push
        run: |
          ENV="${{ needs.preflight.outputs.environment }}"
          NAMESPACE="${{ needs.preflight.outputs.namespace }}"
          BUILD_NUM="${{ needs.preflight.outputs.build_number }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Extrair t√≠tulo do commit (primeira linha)
          COMMIT_TITLE=$(echo "$COMMIT_MSG" | head -1 | cut -c1-80)

          # Verificar se h√° mudan√ßas
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
            exit 0
          fi

          # Listar servi√ßos que foram deployados baseado em quais builds rodaram
          SERVICES=""
          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-be"
          fi
          if [ "${{ needs.build-frontend.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-fe"
          fi
          if [ "${{ needs.build-auth.result }}" == "success" ]; then
            SERVICES="${SERVICES} nexo-auth"
          fi

          # Se nenhum build rodou (todos skipped), significa que for√ßamos build de tudo
          if [ -z "$SERVICES" ]; then
            SERVICES=" nexo-be nexo-fe nexo-auth"
          fi

          # Formato: #001: Merge pull request #20 | deploy(prod):services ‚Üí sha
          git commit -m "${BUILD_NUM}: ${COMMIT_TITLE} | deploy(${ENV}):${SERVICES} ‚Üí ${SHORT_SHA} [skip ci]"
          git push origin ${{ github.ref_name }}

          echo "‚úÖ Deployed to $NAMESPACE"

      - name: Summary
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ needs.preflight.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace**: ${{ needs.preflight.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-be | ${{ needs.build-backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-fe | ${{ needs.build-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| nexo-auth | ${{ needs.build-auth.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD detectar√° as mudan√ßas e far√° sync automaticamente." >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # STAGE 10: Discord Notification (executa AP√ìS deploy concluir)
  # ==========================================================================
  notify-discord:
    name: üì¢ Discord Notify
    runs-on: ubuntu-latest
    needs:
      - preflight
      - build-backend
      - build-frontend
      - build-auth
      - deploy
    # Executa AP√ìS o deploy finalizar (sucesso ou falha)
    if: always() && (needs.deploy.result == 'success' || needs.deploy.result == 'failure')
    steps:
      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          ENV="${{ needs.preflight.outputs.environment }}"
          NAMESPACE="${{ needs.preflight.outputs.namespace }}"
          BUILD_NUM="${{ needs.preflight.outputs.build_number }}"
          BRANCH="${{ needs.preflight.outputs.branch }}"
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"

          # Determinar status e cor baseado no resultado do deploy
          if [ "$DEPLOY_RESULT" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="sucesso"
            TITLE_EMOJI="üöÄ"
            # Cor baseada no ambiente para sucesso
            case "$ENV" in
              dev) COLOR=3066993 ;; # Verde
              qa) COLOR=15844367 ;; # Amarelo
              staging) COLOR=15105570 ;; # Laranja
              prod) COLOR=15158332 ;; # Vermelho
              *) COLOR=3447003 ;; # Azul
            esac
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="falhou"
            TITLE_EMOJI="üî¥"
            COLOR=15158332 # Vermelho para falha
          fi

          # Determinar servi√ßos e seus status
          SERVICES=""
          if [ "${{ needs.build-backend.result }}" == "success" ]; then
            SERVICES="${SERVICES}‚úÖ nexo-be\n"
          elif [ "${{ needs.build-backend.result }}" == "failure" ]; then
            SERVICES="${SERVICES}‚ùå nexo-be\n"
          elif [ "${{ needs.build-backend.result }}" == "skipped" ]; then
            SERVICES="${SERVICES}‚è≠Ô∏è nexo-be (skipped)\n"
          fi

          if [ "${{ needs.build-frontend.result }}" == "success" ]; then
            SERVICES="${SERVICES}‚úÖ nexo-fe\n"
          elif [ "${{ needs.build-frontend.result }}" == "failure" ]; then
            SERVICES="${SERVICES}‚ùå nexo-fe\n"
          elif [ "${{ needs.build-frontend.result }}" == "skipped" ]; then
            SERVICES="${SERVICES}‚è≠Ô∏è nexo-fe (skipped)\n"
          fi

          if [ "${{ needs.build-auth.result }}" == "success" ]; then
            SERVICES="${SERVICES}‚úÖ nexo-auth\n"
          elif [ "${{ needs.build-auth.result }}" == "failure" ]; then
            SERVICES="${SERVICES}‚ùå nexo-auth\n"
          elif [ "${{ needs.build-auth.result }}" == "skipped" ]; then
            SERVICES="${SERVICES}‚è≠Ô∏è nexo-auth (skipped)\n"
          fi

          # Limpar mensagem de commit (remover [skip ci] e caracteres especiais que quebram JSON)
          COMMIT_MSG=$(echo "$COMMIT_MSG" | head -1 | sed 's/\[skip ci\]//g' | tr -d '"\\' | sed "s/'/\"/g" | cut -c1-100)

          # Se SERVICES estiver vazio, colocar mensagem padr√£o
          if [ -z "$SERVICES" ]; then
            SERVICES="Nenhum servi√ßo alterado"
          fi

          # Verificar se o webhook est√° configurado
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "‚ùå DISCORD_WEBHOOK n√£o est√° configurado!"
            exit 1
          fi

          echo "üì§ Enviando notifica√ß√£o para Discord..."
          echo "   Webhook configurado: ‚úÖ"
          echo "   Ambiente: $ENV"
          echo "   Status: $STATUS_TEXT"

          # Enviar notifica√ß√£o com tratamento de erro
          HTTP_RESPONSE=$(curl -s -o /tmp/discord_response.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"${TITLE_EMOJI} Deploy ${BUILD_NUM} - ${ENV^^} ${STATUS_EMOJI}\",
                \"description\": \"Deploy ${STATUS_TEXT} no ambiente **${ENV}**\",
                \"color\": ${COLOR},
                \"fields\": [
                  {
                    \"name\": \"üì¶ Ambiente\",
                    \"value\": \"${ENV} (${NAMESPACE})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üîÄ Branch\",
                    \"value\": \"${BRANCH}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üìù Commit\",
                    \"value\": \"[\`${SHORT_SHA}\`](https://github.com/${REPO}/commit/${{ github.sha }})\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"üí¨ Mensagem\",
                    \"value\": \"${COMMIT_MSG}\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"üìã Servi√ßos\",
                    \"value\": \"${SERVICES}\",
                    \"inline\": false
                  },
                  {
                    \"name\": \"üîó Pipeline\",
                    \"value\": \"[Ver detalhes](${RUN_URL})\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"Nexo Platform ‚Ä¢ Pipeline ${BUILD_NUM}\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK")

          if [ "$HTTP_RESPONSE" -ge 200 ] && [ "$HTTP_RESPONSE" -lt 300 ]; then
            echo "‚úÖ Discord notification sent! (HTTP $HTTP_RESPONSE)"
          else
            echo "‚ùå Failed to send Discord notification (HTTP $HTTP_RESPONSE)"
            echo "Response: $(cat /tmp/discord_response.txt)"
            exit 1
          fi
