# ============================================================================
# NEXO PLATFORM - CI Principal
# ============================================================================
# Workflow Ãºnico de CI para todos os serviÃ§os usando matrix strategy.
# Executa lint, test, build e push de Docker images.
#
# Branch Flow: feature/* â†’ develop â†’ qa â†’ staging â†’ main (production)
# ============================================================================

name: CI

on:
  # Permite disparo manual
  workflow_dispatch:
    inputs:
      force_build:
        description: "ForÃ§ar build de todos os serviÃ§os"
        required: false
        type: boolean
        default: true

  push:
    branches:
      - main
      - staging
      - qa
      - develop
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/**"
      - "local/helm/**"

  pull_request:
    branches:
      - main
      - staging
      - qa
      - develop
    paths:
      - "apps/**"
      - "packages/**"
      - "pnpm-lock.yaml"
      - ".github/workflows/**"
      - "local/helm/**"

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# PermissÃµes necessÃ¡rias para o workflow reutilizÃ¡vel
permissions:
  contents: write # NecessÃ¡rio para commit automÃ¡tico
  packages: write
  security-events: write

jobs:
  # ============================================
  # Verificar se deve executar o CI
  # ============================================
  check-skip:
    name: ðŸ”’ Check Skip
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
    steps:
      - name: Check if commit should skip CI
        id: check
        run: |
          # Obter informaÃ§Ãµes do commit
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          COMMITTER="${{ github.event.head_commit.committer.name }}"
          IS_MERGE="${{ github.event.pull_request.merged || 'false' }}"

          echo "Commit message: $COMMIT_MSG"
          echo "Committer: $COMMITTER"
          echo "Event: ${{ github.event_name }}"

          # NUNCA pular se for um merge de PR ou push direto com cÃ³digo real
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "âœ… Pull request event - running CI"
            exit 0
          fi

          # Pular APENAS se for commit automÃ¡tico do bot E nÃ£o for merge
          if [[ "$COMMITTER" == "github-actions[bot]" ]] && [[ "$COMMIT_MSG" == deploy\(*\):* ]]; then
            # Verificar se hÃ¡ mais de 1 commit (indicando merge)
            PARENT_COUNT=$(echo "${{ github.event.head_commit.id }}" | wc -l)
            
            if [[ "$PARENT_COUNT" -le 1 ]]; then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              echo "â­ï¸ Skipping CI - automated deploy commit"
              exit 0
            fi
          fi

          echo "should_skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Running CI"

  # ============================================
  # Detectar mudanÃ§as para otimizar builds
  # ============================================
  changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    outputs:
      nexo-be: ${{ steps.result.outputs.nexo-be }}
      nexo-fe: ${{ steps.result.outputs.nexo-fe }}
      nexo-auth: ${{ steps.result.outputs.nexo-auth }}
      packages: ${{ steps.result.outputs.packages }}
      infra: ${{ steps.result.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name != 'workflow_dispatch'
        with:
          filters: |
            nexo-be:
              - 'apps/nexo-be/**'
              - 'packages/**'
              - 'pnpm-lock.yaml'
            nexo-fe:
              - 'apps/nexo-fe/**'
              - 'packages/**'
              - 'pnpm-lock.yaml'
            nexo-auth:
              - 'apps/nexo-auth/**'
            packages:
              - 'packages/**'
            infra:
              - 'infra/**'

      - name: Set outputs
        id: result
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.force_build }}" == "true" ]; then
            echo "nexo-be=true" >> $GITHUB_OUTPUT
            echo "nexo-fe=true" >> $GITHUB_OUTPUT
            echo "nexo-auth=true" >> $GITHUB_OUTPUT
            echo "packages=true" >> $GITHUB_OUTPUT
            echo "infra=true" >> $GITHUB_OUTPUT
          else
            echo "nexo-be=${{ steps.filter.outputs.nexo-be }}" >> $GITHUB_OUTPUT
            echo "nexo-fe=${{ steps.filter.outputs.nexo-fe }}" >> $GITHUB_OUTPUT
            echo "nexo-auth=${{ steps.filter.outputs.nexo-auth }}" >> $GITHUB_OUTPUT
            echo "packages=${{ steps.filter.outputs.packages }}" >> $GITHUB_OUTPUT
            echo "infra=${{ steps.filter.outputs.infra }}" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # CI - Backend (NestJS)
  # ============================================
  ci-backend:
    name: ðŸ”µ Backend
    needs: changes
    if: needs.changes.outputs.nexo-be == 'true' || needs.changes.outputs.packages == 'true'
    uses: ./.github/workflows/_ci-reusable.yml
    with:
      service: nexo-be
      working_directory: apps/nexo-be
      build_type: node
      run_tests: true
      run_e2e: true
    secrets: inherit

  # ============================================
  # CI - Frontend (Next.js)
  # ============================================
  ci-frontend:
    name: ðŸŸ¢ Frontend
    needs: changes
    if: needs.changes.outputs.nexo-fe == 'true' || needs.changes.outputs.packages == 'true'
    uses: ./.github/workflows/_ci-reusable.yml
    with:
      service: nexo-fe
      working_directory: apps/nexo-fe
      build_type: node
      run_tests: true
      run_e2e: false
    secrets: inherit

  # ============================================
  # CI - Keycloak Theme (nexo-auth)
  # ============================================
  ci-nexo-auth:
    name: ðŸŸ¡ Nexo Auth
    needs: changes
    if: needs.changes.outputs.nexo-auth == 'true'
    uses: ./.github/workflows/_ci-reusable.yml
    with:
      service: nexo-auth
      working_directory: apps/nexo-auth
      build_type: docker-only
      run_tests: false
    secrets: inherit

  # ============================================
  # Lint Infraestrutura
  # ============================================
  lint-infra:
    name: ðŸ”§ Lint Infra
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: "3.14.0"

      - name: Lint Helm Charts
        run: |
          for chart in infra/helm/*/; do
            echo "ðŸ“‹ Linting $chart"
            helm lint "$chart" || true
          done

      - name: Validate YAML
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: infra/
          config_file: .yamllint.yml
        continue-on-error: true

  # ============================================
  # RelatÃ³rio Final
  # ============================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [check-skip, changes]
    if: always() && needs.check-skip.outputs.should_skip != 'true'
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸ“Š CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.changes.outputs.nexo-be }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.changes.outputs.nexo-fe }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nexo Auth | ${{ needs.changes.outputs.nexo-auth }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Infra | ${{ needs.changes.outputs.infra }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Branch â†’ Environment Mapping" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | Environment | Deploy |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| develop | nexo-develop | Auto |" >> $GITHUB_STEP_SUMMARY
          echo "| qa | nexo-qa | Auto |" >> $GITHUB_STEP_SUMMARY
          echo "| staging | nexo-staging | Auto |" >> $GITHUB_STEP_SUMMARY
          echo "| main | nexo-production | Manual + Approval |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CI workflow completed successfully!" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Auto Trigger CD - Deploy automÃ¡tico apÃ³s CI bem-sucedido
  # ============================================
  auto-deploy:
    name: ðŸš€ Trigger CD
    runs-on: ubuntu-latest
    needs: [check-skip, changes, ci-backend, ci-frontend, ci-nexo-auth]
    if: |
      always() &&
      needs.check-skip.outputs.should_skip != 'true' &&
      github.event_name == 'push' &&
      (needs.ci-backend.result == 'success' || needs.ci-backend.result == 'skipped') &&
      (needs.ci-frontend.result == 'success' || needs.ci-frontend.result == 'skipped') &&
      (needs.ci-nexo-auth.result == 'success' || needs.ci-nexo-auth.result == 'skipped') &&
      (needs.ci-backend.result == 'success' || needs.ci-frontend.result == 'success' || needs.ci-nexo-auth.result == 'success')
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - name: Determine Environment
        id: set-env
        run: |
          case "${{ github.ref }}" in
            refs/heads/develop)
              echo "environment=dev" >> $GITHUB_OUTPUT
              ;;
            refs/heads/qa)
              echo "environment=qa" >> $GITHUB_OUTPUT
              ;;
            refs/heads/staging)
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            refs/heads/main)
              echo "environment=prod" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=none" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Summary
        run: |
          echo "ðŸš€ CD will be triggered for environment: ${{ steps.set-env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY

  #         token: ${{ secrets.GITHUB_TOKEN }}
  #         fetch-depth: 0
  #         ref: develop
  #
  #     ... resto do job comentado para referÃªncia futura ...
