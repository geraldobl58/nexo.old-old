# ============================================================================
# NEXO PLATFORM - CD Principal
# ============================================================================
# Workflow Ãºnico de CD para todos os serviÃ§os e ambientes.
# Usa matrix strategy para deploy em mÃºltiplos ambientes.
#
# Branch Flow: feature/* â†’ develop â†’ qa â†’ staging â†’ main (production)
# Deploy automÃ¡tico para: develop, qa, staging
# Deploy manual com aprovaÃ§Ã£o para: main (production)
# ============================================================================

name: CD

on:
  # Deploy automÃ¡tico apÃ³s CI bem-sucedido
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - staging
      - qa
      - develop

  # Deploy manual via workflow_dispatch
  workflow_dispatch:
    inputs:
      service:
        description: "ServiÃ§o a ser deployado"
        required: true
        type: choice
        options:
          - all
          - nexo-be
          - nexo-fe
          - nexo-auth
      environment:
        description: "Ambiente de deploy"
        required: true
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
      image_tag:
        description: "Tag da imagem (deixe vazio para usar a Ãºltima)"
        required: false
        type: string

concurrency:
  group: cd-${{ github.workflow }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: false

jobs:
  # ============================================
  # Check CI Status (para workflow_run)
  # ============================================
  check-ci:
    name: âœ… Check CI Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check if CI was successful
        id: check
        run: |
          echo "CI Conclusion: ${{ github.event.workflow_run.conclusion }}"
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… CI passou com sucesso, continuando deploy..."
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ CI falhou ou foi cancelado. Deploy NÃƒO serÃ¡ executado."
            echo "Status: ${{ github.event.workflow_run.conclusion }}"
            exit 1
          fi

  # ============================================
  # PreparaÃ§Ã£o
  # ============================================
  prepare:
    name: ðŸ”§ Prepare
    runs-on: ubuntu-latest
    needs: [check-ci]
    # SÃ³ executa se: workflow_dispatch OU check-ci passou (sem always() para nÃ£o ignorar falhas)
    if: |
      github.event_name == 'workflow_dispatch' || 
      (needs.check-ci.result == 'success' && needs.check-ci.outputs.should_deploy == 'true')
    outputs:
      services: ${{ steps.set-matrix.outputs.services }}
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
      auto_sync: ${{ steps.set-env.outputs.auto_sync }}
      require_approval: ${{ steps.set-env.outputs.require_approval }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Services Matrix
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.service }}" == "all" ] || [ -z "${{ github.event.inputs.service }}" ]; then
            echo 'services=["nexo-be", "nexo-fe", "nexo-auth"]' >> $GITHUB_OUTPUT
          else
            echo 'services=["${{ github.event.inputs.service }}"]' >> $GITHUB_OUTPUT
          fi

      - name: Set Environment
        id: set-env
        run: |
          if [ -z "${{ github.event.inputs.environment }}" ]; then
            # Auto-detect based on branch (from workflow_run)
            BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
            case "$BRANCH" in
              develop)
                echo "environment=dev" >> $GITHUB_OUTPUT
                echo "auto_sync=true" >> $GITHUB_OUTPUT
                echo "require_approval=false" >> $GITHUB_OUTPUT
                ;;
              qa)
                echo "environment=qa" >> $GITHUB_OUTPUT
                echo "auto_sync=true" >> $GITHUB_OUTPUT
                echo "require_approval=false" >> $GITHUB_OUTPUT
                ;;
              staging)
                echo "environment=staging" >> $GITHUB_OUTPUT
                echo "auto_sync=false" >> $GITHUB_OUTPUT
                echo "require_approval=true" >> $GITHUB_OUTPUT
                ;;
              main)
                echo "environment=prod" >> $GITHUB_OUTPUT
                echo "auto_sync=false" >> $GITHUB_OUTPUT
                echo "require_approval=true" >> $GITHUB_OUTPUT
                ;;
              *)
                echo "environment=dev" >> $GITHUB_OUTPUT
                echo "auto_sync=true" >> $GITHUB_OUTPUT
                echo "require_approval=false" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            ENV="${{ github.event.inputs.environment }}"
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            if [ "$ENV" == "dev" ] || [ "$ENV" == "qa" ]; then
              echo "auto_sync=true" >> $GITHUB_OUTPUT
              echo "require_approval=false" >> $GITHUB_OUTPUT
            else
              echo "auto_sync=false" >> $GITHUB_OUTPUT
              echo "require_approval=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Set Image Tag
        id: set-tag
        run: |
          if [ -z "${{ github.event.inputs.image_tag }}" ]; then
            echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Deploy Backend
  # ============================================
  deploy-backend:
    name: ðŸ”µ Deploy Backend
    needs: prepare
    if: contains(fromJson(needs.prepare.outputs.services), 'nexo-be')
    uses: ./.github/workflows/_cd-reusable.yml
    with:
      service: nexo-be
      environment: ${{ needs.prepare.outputs.environment }}
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      helm_chart_path: local/helm/nexo-be
      values_file: local/helm/nexo-be/values.yaml
      namespace: nexo-${{ needs.prepare.outputs.environment }}
      auto_sync: ${{ fromJson(needs.prepare.outputs.auto_sync) }}
      require_approval: ${{ fromJson(needs.prepare.outputs.require_approval) }}
    secrets: inherit

  # ============================================
  # Deploy Frontend
  # ============================================
  deploy-frontend:
    name: ðŸŸ¢ Deploy Frontend
    needs: prepare
    if: contains(fromJson(needs.prepare.outputs.services), 'nexo-fe')
    uses: ./.github/workflows/_cd-reusable.yml
    with:
      service: nexo-fe
      environment: ${{ needs.prepare.outputs.environment }}
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      helm_chart_path: local/helm/nexo-fe
      values_file: local/helm/nexo-fe/values.yaml
      namespace: nexo-${{ needs.prepare.outputs.environment }}
      auto_sync: ${{ fromJson(needs.prepare.outputs.auto_sync) }}
      require_approval: ${{ fromJson(needs.prepare.outputs.require_approval) }}
    secrets: inherit

  # ============================================
  # Deploy Nexo Auth (Keycloak Theme)
  # ============================================
  deploy-nexo-auth:
    name: ðŸŸ¡ Deploy Nexo Auth
    needs: prepare
    if: contains(fromJson(needs.prepare.outputs.services), 'nexo-auth')
    uses: ./.github/workflows/_cd-reusable.yml
    with:
      service: nexo-auth
      environment: ${{ needs.prepare.outputs.environment }}
      image_tag: ${{ needs.prepare.outputs.image_tag }}
      helm_chart_path: local/helm/nexo-auth
      values_file: local/helm/nexo-auth/values.yaml
      namespace: nexo-${{ needs.prepare.outputs.environment }}
      auto_sync: ${{ fromJson(needs.prepare.outputs.auto_sync) }}
      require_approval: ${{ fromJson(needs.prepare.outputs.require_approval) }}
    secrets: inherit

  # ============================================
  # RelatÃ³rio Final
  # ============================================
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [prepare, deploy-backend, deploy-frontend, deploy-nexo-auth]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.prepare.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nexo Auth | ${{ needs.deploy-nexo-auth.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
